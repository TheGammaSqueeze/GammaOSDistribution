<?xml version="1.0" encoding="UTF-8"?>
<!--
    The wizard:uris recorded here have the inconvenience of being generated by hand, but they allow
    for the full spread of launch flags (we need FLAG_ACTIVITY_NEW_TASK [0x10000000]), where the
    <intent> tag processed by Intent.parseIntent() does not.

    adb shell am to-intent-uri -a com.android.setupwizard.WELCOME -f 0x10000000 \-\-ez firstRun true
-->
<WizardScript xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard"
    wizard:version="2">

    <!-- Factory Reset Protection (FRP) -->
    <WizardAction id="check_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.CHECK_FRP;end">
        <result wizard:name="resolve_frp"
            wizard:resultCode="101"
            wizard:action="network_settings" />
        <result wizard:action="qr_code_scan" />
    </WizardAction>

    <!-- Network -->
    <WizardAction id="network_settings"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.NETWORK_SETTINGS;end">
        <result wizard:name="use_mobile"
            wizard:resultCode="101"
            wizard:action="activate_mobile_data" />
        <result wizard:name="see_all_wifi"
            wizard:resultCode="102"
            wizard:action="wifi_settings" />
        <result wizard:action="captive_portal" />
    </WizardAction>

    <!-- Activate mobile network -->
    <WizardAction id="activate_mobile_data"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.ACTIVATE_MOBILE_DATA;end">
        <result wizard:action="captive_portal" />
    </WizardAction>

    <!-- Wi-Fi setup -->
    <WizardAction id="wifi_settings"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.WIFI_SETTINGS;end">
        <result wizard:name="use_mobile"
            wizard:resultCode="101"
            wizard:action="activate_mobile_data" />
    </WizardAction>

    <!-- Resolve captive portal access, and wait for check-in -->
    <WizardAction id="captive_portal"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.CAPTIVE_PORTAL;end" />

    <WizardAction id="gms_checkin"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_CHECKIN;end">
        <result wizard:name="timeout"
            wizard:resultCode="101"
            wizard:action="network_timeout" />
        <result wizard:action="load_account_intent_frp" />
    </WizardAction>

    <!-- Network or check-in timeout [REQUIRED] -->
    <WizardAction id="network_timeout"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.NETWORK_TIMEOUT;B.isSkipAllowed=false;end" />

    <!-- Resolve the FRP challenge -->
    <WizardAction id="load_account_intent_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.LOAD_ADD_ACCOUNT_INTENT;B.showTapAndGo=false;B.resolveFrpOnly=true;end" />

    <WizardAction id="resolve_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_SETUP;B.finishWhenDone=true;end">
      <result wizard:name="unintentional_cancel"
          wizard:resultCode="102"
          wizard:action="rollback_auth_early_update" />
      <result wizard:action="qr_code_scan" />
    </WizardAction>

    <!-- Script that includes steps to rollback auth early update [REQUIRED] -->
    <WizardAction id="rollback_auth_early_update"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_rollback_auth_early_update_flow">
      <result wizard:action="load_account_intent_frp" />
    </WizardAction>

    <!-- Scan QR code for device owner provisioning -->
    <WizardAction id="qr_code_scan"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.QR_CODE_SCAN;end">
        <!-- The restore flow would be set to cloud for COPE devices if the result code returned the adding personal account. -->
        <result wizard:name="add_personal_account_after_work_profile"
            wizard:resultCode="120"
            wizard:action="qr_gms_checkin_pre_add_account" />
        <result wizard:name="work_profile_setup"
            wizard:resultCode="122"
            wizard:action="work_profile_setup" />
        <result wizard:name="device_owner_setup"
            wizard:resultCode="123"
            wizard:action="device_owner_setup" />
        <result wizard:action="qr_gms_checkin" />
    </WizardAction>

    <WizardAction id="work_profile_setup"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_post_dpm_provision_finalization_flow">
        <result wizard:action="transition_to_personal_profile_setup" />
    </WizardAction>

    <WizardAction id="device_owner_setup"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_post_dpm_provision_finalization_flow">
        <result wizard:action="qr_gms_checkin" />
    </WizardAction>

    <WizardAction id="transition_to_personal_profile_setup"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.TRANSITION_TO_PERSONAL_PROFILE_SETUP;end">
        <result wizard:action="qr_gms_checkin_pre_add_account" />
    </WizardAction>

    <WizardAction id="qr_gms_checkin_pre_add_account"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_CHECKIN;end" />

    <WizardAction id="add_personal_account_after_work_profile"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_account_flow">
        <result wizard:action="END_OF_SCRIPT" />
    </WizardAction>

    <WizardAction id="qr_gms_checkin"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_CHECKIN;end" />

    <!-- Flow to run after a user-led device policy managed setup. [RECOMMENDED] -->
    <WizardAction id="post_dpm_user_flow"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_post_dpm_user_flow" />

    <WizardAction id="END_OF_SCRIPT" />
</WizardScript>
