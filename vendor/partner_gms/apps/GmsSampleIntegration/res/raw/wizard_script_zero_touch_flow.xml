<?xml version="1.0" encoding="UTF-8"?>
<!--
    The wizard:uris recorded here have the inconvenience of being generated by hand, but they allow
    for the full spread of launch flags (we need FLAG_ACTIVITY_NEW_TASK [0x10000000]), where the
    <intent> tag processed by Intent.parseIntent() does not.

    adb shell am to-intent-uri -a com.android.setupwizard.WELCOME -f 0x10000000 \-\-ez firstRun true
-->
<WizardScript xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard"
    wizard:firstAction="zero_touch_initial">

    <WizardAction id="zero_touch_initial"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ZERO_TOUCH_SETUP;B.checkFrp=true;end">
        <!-- OobConfig handled ZeroTouch, the device is provisioned in Device Owner mode. -->
        <result wizard:name="dpm_user_complete"
            wizard:resultCode="111" />
        <!-- OobConfig or ZT-GMS will handle ZeroTouch, but there is a FRP on the device, and it has to be resolved first. -->
        <result wizard:name="zero_touch_triggered"
            wizard:action="load_account_intent_frp"
            wizard:resultCode="113" />
        <!-- ZT-GMS should handle ZeroTouch, go to setup_as_new flow. -->
        <result wizard:name="gmscore_zero_touch"
            wizard:resultCode="116" />
        <!-- ZT-GMS should handle ZeroTouch, go to load_account_for_zt_gms. -->
        <result wizard:name="zero_touch_gmscore_account_setup"
            wizard:action="load_account_for_zt_gms"
            wizard:resultCode="117" />
        <!-- OobConfig handled ZeroTouch, the device is provisioned in Profile Owner mode. -->
        <result wizard:name="add_personal_account_after_work_profile"
            wizard:resultCode="120" />
        <!-- OobConfig handled ZeroTouch, the device is provisioned as a Financed Device. -->
        <result wizard:name="financed_device_provisioning_complete"
            wizard:resultCode="121" />
        <!-- OobConfig handled ZeroTouch, the device is provisioned in Profile Owner mode but hasn't launched the DPC yet -->
        <result wizard:name="work_profile_setup"
            wizard:resultCode="122" />
        <!-- OobConfig handled ZeroTouch, the device is provisioned in Device Owner mode but hasn't launched the DPC yet -->
        <result wizard:name="device_owner_setup"
            wizard:resultCode="123" />
        <!-- All other result codes exit to parent script -->
    </WizardAction>

   <!-- Load account intent for ZT-GMS [REQUIRED] -->
    <WizardAction id="load_account_for_zt_gms"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.LOAD_ADD_ACCOUNT_INTENT;B.showTapAndGo=false;end">
        <result wizard:action="account_setup_for_zt_gms" />
    </WizardAction>

    <!-- Start Account Setup for ZT-GMS [REQUIRED] -->
    <WizardAction id="account_setup_for_zt_gms"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_SETUP;B.finishWhenDone=true;B.zeroTouch=true;end">
        <result wizard:name="unintentional_cancel"
            wizard:resultCode="102"
            wizard:action="rollback_auth_early_update_for_zt_gms" />
        <!-- Alternate flow if managed provisioning already set the user up (for enterprise) [RECOMMENDED] -->
        <result wizard:name="dpm_user_complete"
            wizard:resultCode="111" />
        <result wizard:name="financed_device_provisioning_complete"
            wizard:resultCode="121" />
        <result wizard:name="work_profile_setup"
            wizard:resultCode="122" />
        <result wizard:name="device_owner_setup"
            wizard:resultCode="123" />
        <!-- All other result codes exit to parent script -->
    </WizardAction>

    <!-- Script that includes steps to rollback auth early update [REQUIRED] -->
    <WizardAction id="rollback_auth_early_update_for_zt_gms"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_rollback_auth_early_update_flow">
        <result wizard:action="load_account_for_zt_gms" />
    </WizardAction>

    <!-- Load account intent for frp [REQUIRED] -->
    <WizardAction id="load_account_intent_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.LOAD_ADD_ACCOUNT_INTENT;B.showTapAndGo=false;B.resolveFrpOnly=true;end">
        <result wizard:action="resolve_frp" />
    </WizardAction>

    <!-- Resolve the FRP challenge [REQUIRED] -->
    <WizardAction id="resolve_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_SETUP;B.finishWhenDone=true;end">
        <result wizard:name="unintentional_cancel"
            wizard:resultCode="102"
            wizard:action="rollback_auth_early_update" />
        <result wizard:action="zero_touch_post_frp" />
    </WizardAction>

    <!-- Script that includes steps to rollback auth early update [REQUIRED] -->
    <WizardAction id="rollback_auth_early_update"
        wizard:script="android.resource://com.google.android.gmsintegration/raw/wizard_script_rollback_auth_early_update_flow">
        <result wizard:action="load_account_intent_frp" />
    </WizardAction>

    <!-- Now that FRP is resolved, let OobConfig or ZT-GMS handle ZeroTouch. [REQUIRED] -->
    <WizardAction id="zero_touch_post_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ZERO_TOUCH_SETUP;end">
        <result wizard:name="zero_touch_gmscore_account_setup"
            wizard:resultCode="117"
            wizard:action="load_account_for_zt_gms" />
    </WizardAction>
</WizardScript>
