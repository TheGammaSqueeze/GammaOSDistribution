<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.stevesoltys.seedvault"
    android:versionCode="31000301"
    android:versionName="12-3.0" >

    <uses-sdk
        android:minSdkVersion="32"
        android:targetSdkVersion="32" />
    <!--
    The version code is the targeted SDK_VERSION plus 6 digits for our own version code.
    The version name is the targeted Android version followed by - and our own version name.
    -->

    <uses-permission android:name="android.permission.BACKUP" />

    <!-- This is needed to check for internet access when backup is stored on network storage -->
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- This is needed to retrieve the available storage roots -->
    <uses-permission android:name="android.permission.MANAGE_DOCUMENTS" />

    <!-- This is needed to access the serial number of USB mass storage devices -->
    <uses-permission android:name="android.permission.MANAGE_USB" />

    <!-- This is needed to change system backup settings -->
    <uses-permission android:name="android.permission.WRITE_SECURE_SETTINGS" />

    <!-- This is needed to re-install backed-up packages when restoring from backup -->
    <uses-permission android:name="android.permission.INSTALL_PACKAGES" />

    <!--
         This is needed when using auto-restore with removable storage
         to allow the user to uninstall an app when storage was not plugged in during install
    -->
    <uses-permission android:name="android.permission.REQUEST_DELETE_PACKAGES" />

    <!--
         Getting info about installed packages via PackageManager is restricted since Android 11
         We need to know what is installed, with what signatures, etc. for APK backup,
         triggering manual backup and other tasks
    -->
    <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />

    <!-- Used to authenticate saving a new recovery code -->
    <uses-permission android:name="android.permission.USE_BIOMETRIC" />

    <!-- Permission used to open settings -->
    <permission
        android:name="com.stevesoltys.seedvault.OPEN_SETTINGS"
        android:protectionLevel="system|signature" />

    <!-- Permission used to open backup gui -->
    <permission
        android:name="com.stevesoltys.seedvault.RESTORE_BACKUP"
        android:protectionLevel="system|signature" />

    <!-- This is needed to query content providers in other users -->
    <uses-permission android:name="android.permission.INTERACT_ACROSS_USERS_FULL" />
    <uses-permission
        android:name="android.permission.READ_EXTERNAL_STORAGE"
        android:maxSdkVersion="29" />
    <uses-permission
        android:name="android.permission.WRITE_EXTERNAL_STORAGE"
        android:maxSdkVersion="29" />
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" /> <!-- Needed to backup original media files e.g. without stripped EXIF metadata -->
    <uses-permission android:name="android.permission.ACCESS_MEDIA_LOCATION" /> <!-- Needed to schedule the periodic backup job -->
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" /> <!-- Needed to run a periodic backup service that doesn't get killed -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />

    <application
        android:name="com.stevesoltys.seedvault.App"
        android:allowBackup="false"
        android:appComponentFactory="androidx.core.app.CoreComponentFactory"
        android:extractNativeLibs="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme"
        android:usesNonSdkApi="true" >
        <activity
            android:name="com.stevesoltys.seedvault.settings.SettingsActivity"
            android:exported="true"
            android:permission="com.stevesoltys.seedvault.OPEN_SETTINGS" />
        <activity
            android:name="com.stevesoltys.seedvault.ui.storage.StorageActivity"
            android:theme="@style/AppTheme.NoActionBar" />
        <activity
            android:name="com.stevesoltys.seedvault.ui.storage.PermissionGrantActivity"
            android:exported="false"
            android:permission="android.permission.MANAGE_DOCUMENTS" />
        <activity
            android:name="com.stevesoltys.seedvault.ui.recoverycode.RecoveryCodeActivity"
            android:label="@string/recovery_code_title"
            android:theme="@style/AppTheme.NoActionBar" />
        <activity
            android:name="com.stevesoltys.seedvault.restore.RestoreActivity"
            android:exported="true"
            android:label="@string/restore_title"
            android:permission="com.stevesoltys.seedvault.RESTORE_BACKUP"
            android:theme="@style/AppTheme.NoActionBar" >
            <intent-filter>
                <action android:name="com.stevesoltys.seedvault.RESTORE_BACKUP" />

                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>

        <service
            android:name="com.stevesoltys.seedvault.transport.ConfigurableBackupTransportService"
            android:exported="false" >
            <intent-filter>
                <action android:name="android.backup.TRANSPORT_HOST" />
            </intent-filter>
        </service>

        <receiver
            android:name="com.stevesoltys.seedvault.UsbIntentReceiver"
            android:exported="true" >
            <intent-filter>
                <action android:name="android.hardware.usb.action.USB_DEVICE_ATTACHED" />
            </intent-filter>

            <meta-data
                android:name="android.hardware.usb.action.USB_DEVICE_ATTACHED"
                android:resource="@xml/device_filter" />
        </receiver>
        <receiver
            android:name="com.stevesoltys.seedvault.restore.RestoreErrorBroadcastReceiver"
            android:exported="false" >
            <intent-filter>
                <action android:name="com.stevesoltys.seedvault.action.UNINSTALL" />
            </intent-filter>
        </receiver>
        <receiver
            android:name="com.stevesoltys.seedvault.SecretCodeReceiver"
            android:exported="true" >
            <intent-filter>
                <action android:name="android.telephony.action.SECRET_CODE" />
                <!-- *#*#RESTORE#*#* -->
                <data
                    android:host="7378673"
                    android:scheme="android_secret_code" />
            </intent-filter>
        </receiver>

        <!-- Used to start actual BackupService depending on scheduling criteria -->
        <service
            android:name="com.stevesoltys.seedvault.storage.StorageBackupJobService"
            android:exported="false"
            android:label="BackupJobService"
            android:permission="android.permission.BIND_JOB_SERVICE" />
        <!-- Does the actual backup work as a foreground service -->
        <service
            android:name="com.stevesoltys.seedvault.storage.StorageBackupService"
            android:exported="false"
            android:foregroundServiceType="dataSync"
            android:label="BackupService" />
        <!-- Does restore as a foreground service -->
        <service
            android:name="com.stevesoltys.seedvault.storage.StorageRestoreService"
            android:exported="false"
            android:foregroundServiceType="dataSync"
            android:label="RestoreService" />
        <service
            android:name="androidx.room.MultiInstanceInvalidationService"
            android:directBootAware="true"
            android:exported="false" />
    </application>

</manifest>